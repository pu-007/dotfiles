%% Pandoc Custom Template for CTeX
\documentclass[12pt,a4paper]{ctexart}

% --- 基础宏包 ---
\usepackage{microtype}
\usepackage{xcolor}
\usepackage{amsmath,amssymb}
\usepackage{setspace}
\usepackage{geometry}
\usepackage{graphicx}

% --- 表格支持 (修复 Pandoc 表格报错的关键) ---
\usepackage{array}      % 提供 \arraybackslash 和 >{...} 语法
\usepackage{longtable}  % Pandoc 默认长表
\usepackage{booktabs}   % 三线表支持
\usepackage{multirow}   % 支持跨行单元格
\usepackage{calc}       % 支持列宽计算 (\real 命令)

% --- 修复 Pandoc 必须的宏定义 ---
% 1. 修复 \tightlist 错误
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% 2. 让图片自动适应页面宽度
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

% 3. 处理超链接 (建议放在最后加载)
\usepackage[hidelinks]{hyperref}

% --- 页面几何与行距 ---
\geometry{a4paper,left=2cm,top=0.5cm,right=0.5cm,bottom=0.5cm}
\setstretch{1.4}

% --- 字体设置 ---
\usepackage{fontspec}

% Fallback 选项需要 TeXLive 2019+
\setmainfont{JetXW}[
    Fallback = {Noto Sans, Noto Sans Symbols 2}
]
\setsansfont{JetXW}[
    Fallback = {Noto Sans, Noto Sans Symbols 2}
]
\setmonofont{JetXW}[
    Fallback = {Noto Sans Mono, Noto Sans Symbols 2}
]
\setCJKmainfont{JetXW}[
    Fallback = {Noto Sans CJK SC, Noto Sans Symbols 2}
]

% --- 标题样式定制 ---
\usepackage[explicit]{titlesec} 

\setlength{\arrayrulewidth}{0.5pt}
\renewcommand{\arraystretch}{1.3}

% H1: 深灰背景 + 白字
\titleformat{\section}[block]
{\Large\bfseries\color{white}}
{}
{0pt}
{\colorbox{black!80}{\parbox{\dimexpr\textwidth-2\fboxsep\relax}{\thesection\quad #1}}}

% H2: 浅灰背景 + 黑字
\titleformat{\subsection}[block]
{\large\bfseries}
{}
{0pt}
{\colorbox{black!10}{\parbox{\dimexpr\textwidth-2\fboxsep\relax}{\thesubsection\quad #1}}}

% H3: 底部实线
\titleformat{\subsubsection}[hang]
{\normalsize\bfseries}
{\thesubsubsection}
{1em}
{#1}
[{\titlerule[0.8pt]}]

% H4: 底部虚线
\titleformat{\paragraph}[hang]
{\normalsize\bfseries}
{\theparagraph}
{1em}
{#1\ \titlerule*[0.5pc]{-}} 

% 调整标题间距
\titlespacing*{\section}{0pt}{1.5ex plus 1ex minus .2ex}{1ex plus .2ex}
\titlespacing*{\subsection}{0pt}{1.5ex plus 1ex minus .2ex}{1ex plus .2ex}
\titlespacing*{\subsubsection}{0pt}{1.5ex plus 1ex minus .2ex}{1ex plus .2ex}
\titlespacing*{\paragraph}{0pt}{1ex plus 1ex minus .2ex}{0.5ex plus .2ex}

% --- 代码高亮 ---
$if(highlighting-includes)$
$highlighting-includes$
$endif$

% --- Header Includes ---
$for(header-includes)$
$header-includes$
$endfor$

\begin{document}

$if(title)$
\maketitle
$endif$

$if(toc)$
\tableofcontents
\newpage
$endif$

$body$

$if(references)$
\section*{References}
$references$
$endif$

\end{document}
